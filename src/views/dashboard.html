<!DOCTYPE html>
<html lang="pt-pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | O Meu Bolso</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'navy': '#14213D',
                        'gold': '#FCA311',
                        'light-gray': '#E5E5E5',
                        'white': '#FFFFFF',
                        'black': '#000000',
                    },
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #14213D;
        }

        ::-webkit-scrollbar-thumb {
            background: #FCA311;
            border-radius: 4px;
        }
    </style>
</head>

<body class="bg-navy text-white min-h-screen">

    <!-- Header -->
    <header class="sticky top-0 z-50 bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <svg class="w-9 h-9 text-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z">
                    </path>
                </svg>
                <span class="text-navy text-2xl font-black tracking-tight">O Meu Bolso</span>
            </div>

            <div class="flex items-center space-x-6">
                <span class="hidden md:block text-navy font-medium">Ol√°, <span id="headerName"
                        class="text-gold font-bold">...</span></span>
                <button id="btn-logout"
                    class="bg-gold text-navy font-semibold px-5 py-2 rounded-lg hover:bg-opacity-90 transition">
                    Sair
                </button>
            </div>
        </div>
    </header>

    <!-- Main -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">

        <!-- Welcome -->
        <div class="mb-10">
            <h1 class="text-4xl md:text-5xl font-extrabold">
                Bem-vindo de volta, <span id="userName" class="text-gold">...</span>!
            </h1>
            <p class="text-light-gray mt-2">Aqui est√° o resumo das suas finan√ßas hoje.</p>
        </div>

        <!-- Layout Principal -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <div class="lg:col-span-2 space-y-8">

                <!-- 1. Contas -->
                <div class="bg-white rounded-2xl shadow-xl text-navy flex flex-col max-h-96 overflow-hidden">
                    <div
                        class="flex justify-between items-center px-6 py-4 bg-white border-b border-light-gray sticky top-0 z-10 shadow-sm">
                        <h2 class="text-2xl font-bold">Contas</h2>
                        <button id="openAccountModal"
                            class="bg-gold text-navy px-5 py-2.5 rounded-lg font-semibold hover:bg-opacity-90 transition shadow-md">
                            + Nova conta
                        </button>
                    </div>
                    <div id="accountsList" class="space-y-4 p-6 flex-1 overflow-y-auto"></div>
                </div>

                <!-- 2. Despesas & Rendimentos -->
                <div class="bg-white rounded-2xl shadow-xl text-navy flex flex-col max-h-96 overflow-hidden">
                    <div
                        class="flex justify-between items-center px-6 py-4 bg-white border-b border-light-gray sticky top-0 z-10 shadow-sm">
                        <h2 class="text-2xl font-bold">Despesas & Rendimentos</h2>
                        <button id="openTransactionModal"
                            class="bg-gold text-navy px-4 py-2 rounded-lg font-medium hover:bg-opacity-90 transition">
                            + Nova transa√ß√£o
                        </button>
                    </div>
                    <div id="transactionsList" class="space-y-4 p-6 flex-1 overflow-y-auto"></div>
                </div>

                <!-- 3. Limites Mensais -->
                <div class="bg-white rounded-2xl shadow-xl p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-navy">Limites Mensais <span id="limitsMonthYear"
                                class="text-gold">(Dezembro 2025)</span></h2>
                        <button id="openLimitsModal"
                            class="bg-gold text-navy px-5 py-2.5 rounded-lg font-semibold hover:bg-opacity-90 transition shadow-md">
                            + Novo Limite
                        </button>
                    </div>

                    <div id="limitsList" class="space-y-6">
                        <!-- Limites carregados dinamicamente -->
                    </div>
                </div>
            </div>

            <div class="space-y-8">

                <!-- 4. Metas Financeiras -->
                <div class="bg-white rounded-2xl shadow-xl p-6">
                    <h2 class="text-2xl font-bold text-navy mb-6">Metas Ativas</h2>
                    <div id="goalsList" class="space-y-5">
                        <!-- Metas carregadas dinamicamente -->
                    </div>
                    <button id="openGoalModal"
                        class="w-full mt-4 bg-gold text-navy font-semibold py-3 rounded-lg hover:bg-opacity-90 transition">
                        + Nova Meta
                    </button>
                </div>

                <!-- 5. Conversor de Moedas -->
                <div class="bg-white rounded-2xl shadow-xl p-6 text-center">
                    <div class="opacity-60">
                        <div
                            class="w-20 h-20 mx-auto mb-4 bg-light-gray/30 rounded-full flex items-center justify-center text-5xl">
                            üí±
                        </div>
                        <h3 class="text-xl font-bold text-navy mb-2">Conversor de Moedas</h3>
                        <p class="text-sm text-gray-500">Funcionalidade em desenvolvimento.<br>Em breve com taxas em
                            tempo real.</p>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <!-- Modal Conta -->
    <div id="accountModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md text-navy">
            <h3 id="accountModalTitle" class="text-2xl font-bold mb-6">Nova Conta</h3>
            <form id="accountForm">
                <input type="hidden" id="accountId" value="">
                <div class="mb-6">
                    <label class="block font-medium mb-2">Nome da conta</label>
                    <input type="text" id="accountName" required placeholder="ex: Millennium BCP"
                        class="w-full px-4 py-3 border border-light-gray rounded-lg focus:outline-none focus:border-gold">
                </div>
                <div class="mb-6">
                    <label class="block font-medium mb-2">Tipo de conta</label>
                    <select id="accountType" required
                        class="w-full px-4 py-3 border border-light-gray rounded-lg focus:outline-none focus:border-gold">
                        <option value="corrente">Conta √† ordem</option>
                        <option value="poupanca">Conta poupan√ßa</option>
                        <option value="conjunta">Conta conjunta</option>
                        <option value="salario">Conta sal√°rio</option>
                        <option value="universitaria">Conta universit√°ria</option>
                        <option value="outra">Outra</option>
                    </select>
                </div>
                <div class="mb-6">
                    <label class="block font-medium mb-2">Saldo inicial (‚Ç¨)</label>
                    <input type="number" id="accountBalance" step="0.01" min="0" required placeholder="0.00"
                        class="w-full px-4 py-3 border border-light-gray rounded-lg focus:outline-none focus:border-gold">
                </div>
                <div class="flex gap-4">
                    <button type="button" onclick="closeModal('accountModal', event)"
                        class="flex-1 py-3 border border-gray-300 rounded-lg hover:bg-light-gray transition">
                        Cancelar
                    </button>
                    <button type="submit"
                        class="flex-1 bg-gold font-bold py-3 rounded-lg hover:bg-opacity-90 transition">
                        Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Transa√ß√£o -->
    <div id="transactionModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md text-navy max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-6">Nova Transa√ß√£o</h3>
            <form id="transactionForm">
                <div class="mb-6">
                    <label class="block font-medium mb-2">Descri√ß√£o</label>
                    <input type="text" id="transactionDescription" required placeholder="ex: Supermercado Continente"
                        class="w-full px-4 py-3 border border-light-gray rounded-lg focus:outline-none focus:border-gold">
                </div>
                <div class="mb-6">
                    <label class="block font-medium mb-2">Conta</label>
                    <select id="transactionAccount" required
                        class="w-full px-4 py-3 border border-light-gray rounded-lg focus:outline-none focus:border-gold">
                        <option value="">Selecione uma conta</option>
                    </select>
                </div>
                <div class="mb-6">
                    <label class="block font-medium mb-2">Valor (‚Ç¨)</label>
                    <input type="number" id="transactionAmount" step="0.01" min="0.01" required placeholder="0.00"
                        class="w-full px-4 py-3 border border-light-gray rounded-lg focus:outline-none focus:border-gold">
                </div>
                <div class="mb-6">
                    <label class="block font-medium mb-2">Tipo</label>
                    <select id="transactionType" required
                        class="w-full px-4 py-3 border border-light-gray rounded-lg focus:outline-none focus:border-gold">
                        <option value="expense">Despesa</option>
                        <option value="income">Rendimento</option>
                    </select>
                </div>
                <div class="mb-6">
                    <label class="block font-medium mb-2">Categoria</label>
                    <select id="transactionCategory" required
                        class="w-full px-4 py-3 border border-light-gray rounded-lg focus:outline-none focus:border-gold">
                        <option value="">Selecione uma categoria</option>
                        <option value="Alimenta√ß√£o">Alimenta√ß√£o</option>
                        <option value="Sa√∫de">Sa√∫de</option>
                        <option value="Lazer">Lazer</option>
                        <option value="Transporte">Transporte</option>
                        <option value="Outros">Outros</option>
                    </select>
                </div>
                <div class="mb-6">
                    <label class="block font-medium mb-2">Data</label>
                    <input type="date" id="transactionDate" required
                        class="w-full px-4 py-3 border border-light-gray rounded-lg focus:outline-none focus:border-gold">
                </div>
                <div class="flex gap-4">
                    <button type="button" onclick="closeModal('transactionModal', event)"
                        class="flex-1 py-3 border border-gray-300 rounded-lg hover:bg-light-gray transition">
                        Cancelar
                    </button>
                    <button type="submit"
                        class="flex-1 bg-gold font-bold py-3 rounded-lg hover:bg-opacity-90 transition">
                        Registar Transa√ß√£o
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Limites Mensais -->
    <div id="limitsModal" class="fixed inset-0 bg-black/70 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4">
            <h3 id="limitModalTitle" class="text-2xl font-bold text-navy mb-6">Configurar Limite</h3>
            <form id="limitForm">
                <input type="hidden" id="limitId" value="">
                <div class="mb-6">
                    <label class="block text-navy font-medium mb-2">Categoria</label>
                    <select id="limitCategory" required
                        class="w-full px-4 py-3 border border-light-gray rounded-lg focus:outline-none focus:border-gold text-navy">
                        <option value="" disabled selected>A carregar...</option>
                    </select>
                </div>
                <div class="mb-6">
                    <label class="block text-navy font-medium mb-2">Limite Mensal (‚Ç¨)</label>
                    <input type="number" id="limitAmount" step="0.01" min="0" required placeholder="0.00"
                        class="w-full px-4 py-3 border border-light-gray rounded-lg focus:outline-none focus:border-gold text-navy">
                </div>
                <div class="grid grid-cols-2 gap-4 mb-8">
                    <div>
                        <label class="block text-navy font-medium mb-2">M√™s</label>
                        <select id="limitMonth"
                            class="w-full px-4 py-3 border border-light-gray rounded-lg focus:outline-none focus:border-gold text-navy">
                            <option value="1">Janeiro</option>
                            <option value="2">Fevereiro</option>
                            <option value="3">Mar√ßo</option>
                            <option value="4">Abril</option>
                            <option value="5">Maio</option>
                            <option value="6">Junho</option>
                            <option value="7">Julho</option>
                            <option value="8">Agosto</option>
                            <option value="9">Setembro</option>
                            <option value="10">Outubro</option>
                            <option value="11">Novembro</option>
                            <option value="12" selected>Dezembro</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-navy font-medium mb-2">Ano</label>
                        <input type="number" id="limitYear" value="2025" min="2020" max="2040"
                            class="w-full px-4 py-3 border border-light-gray rounded-lg focus:outline-none focus:border-gold text-navy">
                    </div>
                </div>
                <div class="flex gap-4">
                    <button type="button" onclick="closeModal('limitsModal', event)"
                        class="flex-1 py-3 border border-gray-300 text-navy rounded-lg hover:bg-light-gray transition">
                        Cancelar
                    </button>
                    <button type="submit"
                        class="flex-1 bg-gold font-navy font-bold py-3 rounded-lg hover:bg-opacity-90 transition">
                        Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Metas -->
    <div id="goalModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md text-navy">
            <h3 id="goalModalTitle" class="text-2xl font-bold mb-6">Nova Meta Financeira</h3>
            <form id="goalForm">
                <input type="hidden" id="goalId" value="">

                <div class="mb-6">
                    <label class="block font-medium mb-2">O que queres alcan√ßar?</label>
                    <input type="text" id="goalName" required placeholder="ex: Viagem ao Jap√£o"
                        class="w-full px-4 py-3 border border-light-gray rounded-lg focus:outline-none focus:border-gold">
                </div>
                <div class="mb-6">
                    <label class="block font-medium mb-2">Valor total (‚Ç¨)</label>
                    <input type="number" id="goalTarget" step="0.01" min="0.01" required placeholder="0.00"
                        class="w-full px-4 py-3 border border-light-gray rounded-lg focus:outline-none focus:border-gold">
                </div>
                <div class="mb-6">
                    <label class="block font-medium mb-2">Valor j√° poupado (‚Ç¨)</label>
                    <input type="number" id="goalCurrent" step="0.01" min="0" value="0" required placeholder="0.00"
                        class="w-full px-4 py-3 border border-light-gray rounded-lg focus:outline-none focus:border-gold">
                </div>
                <div class="mb-6">
                    <label class="block font-medium mb-2">Data limite</label>
                    <input type="date" id="goalDeadline" required
                        class="w-full px-4 py-3 border border-light-gray rounded-lg focus:outline-none focus:border-gold">
                </div>
                <div class="flex gap-4">
                    <button type="button" onclick="closeModal('goalModal', event)"
                        class="flex-1 py-3 border border-gray-300 rounded-lg hover:bg-light-gray transition">
                        Cancelar
                    </button>
                    <button type="submit"
                        class="flex-1 bg-gold font-bold py-3 rounded-lg hover:bg-opacity-90 transition">
                        <span id="goalSubmitText">Criar Meta</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Vari√°veis de Estado
        let accounts = [];
        let transactions = [];
        let budgets = [];
        let goals = [];
        let categories = []; // Nova vari√°vel de estado para categorias
        let currentLimitsMonth = new Date().getMonth() + 1;
        let currentLimitsYear = new Date().getFullYear();

        // --- FUN√á√ïES AUXILIARES ---

        // Fun√ß√£o gen√©rica para exibir erros
        function showError(message) {
            alert("Erro: " + message);
            console.error(message);
        }

        // Modais (L√≥gica Visual mantida)
        function openModal(id) {
            const modal = document.getElementById(id);
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
        }
        function closeModal(id, event) {
            if (event) {
                event.preventDefault(); // Impede a submiss√£o do formul√°rio
            }
            const modal = document.getElementById(id);
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }
        // Fecha modal ao clicar fora
        document.querySelectorAll('[id$="Modal"]').forEach(m => {
            m.addEventListener('click', e => { if (e.target === m) closeModal(m.id); });
        });

        // --- API & CARREGAMENTO DE DADOS ---

        async function fetchAllData() {
            try {
                // Carrega tudo em paralelo: Contas, Transa√ß√µes, Or√ßamentos, Metas e CATEGORIAS
                const [accRes, transRes, budRes, goalRes, catRes] = await Promise.all([
                    fetch('/api/accounts'),
                    fetch('/api/transactions'),
                    fetch('/api/budgets'),
                    fetch('/api/goals'),
                    fetch('/api/categories')
                ]);

                if (accRes.ok) accounts = await accRes.json();
                if (transRes.ok) transactions = await transRes.json();
                if (budRes.ok) budgets = await budRes.json();
                if (goalRes.ok) goals = await goalRes.json();
                if (catRes.ok) categories = await catRes.json();

                // Renderiza tudo na ordem correta
                renderAccounts();
                renderTransactions(); // Precisa de accounts e categories carregados
                renderGoals();
                calculateBudgetsProgress(); // Precisa de transactions e budgets carregados

            } catch (error) {
                console.error("Erro ao carregar dados:", error);
            }
        }

        // --- GEST√ÉO DE CONTAS ---

        function renderAccounts() {
            const list = document.getElementById('accountsList');
            list.innerHTML = '';

            if (!accounts || accounts.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-500 py-8">Nenhuma conta registada ainda.</p>';
                return;
            }

            accounts.forEach(acc => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-light-gray/20 p-4 rounded-xl mb-3';
                div.innerHTML = `
        <div class="flex items-center space-x-4">
            <div class="w-12 h-12 bg-gold/20 rounded-full flex items-center justify-center text-2xl">üí≥</div>
            <div>
                <p class="font-semibold text-navy">${acc.nome}</p>
                <p class="text-sm text-gray-500">${acc.tipo.charAt(0).toUpperCase() + acc.tipo.slice(1)}</p>
            </div>
        </div>
        <div class="text-right">
            <p class="text-xl font-bold text-navy">‚Ç¨${parseFloat(acc.saldo_atual).toFixed(2)}</p>
            <div class="mt-2 space-x-4">
                <button onclick="deleteAccount('${acc.id}')"
                    class="text-sm text-red-600 underline hover:text-red-800">Excluir</button>
            </div>
        </div>
        `;
                list.appendChild(div);
            });
        }

        // Criar Conta (POST)
        document.getElementById('accountForm').addEventListener('submit', async e => {
            e.preventDefault();

            const nome = document.getElementById('accountName').value.trim();
            const tipo = document.getElementById('accountType').value;
            const saldo = parseFloat(document.getElementById('accountBalance').value);

            try {
                const res = await fetch('/api/accounts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: nome,
                        type: tipo,
                        balance: saldo
                    })
                });

                if (res.ok) {
                    await fetchAllData();
                    closeModal('accountModal');
                    document.getElementById('accountForm').reset();
                } else {
                    const err = await res.json();
                    showError(err.error || 'Erro ao criar conta');
                }
            } catch (error) { showError(error.message); }
        });

        // Apagar Conta (DELETE)
        window.deleteAccount = async function (id) {
            if (!confirm('Tens a certeza? Isto apagar√° tamb√©m as transa√ß√µes associadas.')) return;

            try {
                const res = await fetch(`/api/accounts/${id}`, { method: 'DELETE' });
                if (res.ok) fetchAllData();
            } catch (error) { console.error(error); }
        };

        document.getElementById('openAccountModal').addEventListener('click', () => {
            document.getElementById('accountModalTitle').textContent = 'Nova Conta';
            document.getElementById('accountForm').reset();
            openModal('accountModal');
        });


        // --- GEST√ÉO DE TRANSA√á√ïES ---

        function loadAccountOptions() {
            const select = document.getElementById('transactionAccount');
            select.innerHTML = '<option value="">Selecione uma conta</option>';
            accounts.forEach(acc => {
                const opt = document.createElement('option');
                opt.value = acc.id;
                opt.textContent = `${acc.nome} (‚Ç¨${parseFloat(acc.saldo_atual).toFixed(2)})`;
                select.appendChild(opt);
            });
        }

        // Carrega as categorias no <select> do modal de transa√ß√µes
        function loadCategoryOptions(selectedType = null) {
            const select = document.getElementById('transactionCategory');
            if (!select) return; // Se o elemento n√£o existir no HTML, ignora

            select.innerHTML = '<option value="">Sem categoria</option>';

            // Filtra categorias se um tipo for passado, sen√£o mostra todas
            const filteredCategories = selectedType
                ? categories.filter(c => c.type === selectedType || c.type === 'both')
                : categories;

            filteredCategories.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat.id;
                opt.textContent = cat.nome;
                select.appendChild(opt);
            });
        }

        // Listener para atualizar categorias quando o tipo de transa√ß√£o muda
        document.getElementById('transactionType')?.addEventListener('change', (e) => {
            loadCategoryOptions(e.target.value);
        });

        function renderTransactions() {
            const container = document.getElementById('transactionsList');
            container.innerHTML = '';

            if (!transactions || transactions.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-8">Nenhuma transa√ß√£o registada ainda.</p>';
                return;
            }

            // Ordenar por data (mais recente primeiro)
            const sorted = [...transactions].sort((a, b) => new Date(b.data) - new Date(a.data));

            sorted.forEach(trans => {
                const accountName = accounts.find(a => a.id === trans.account_id)?.nome || 'Desconhecida';

                // Encontrar nome da categoria pelo ID ou pelo objeto populado
                let catName = '';
                if (trans.category_id) {
                    const catObj = categories.find(c => c.id === trans.category_id);
                    catName = catObj ? catObj.nome : (trans.categories?.nome || '');
                }

                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-light-gray/20 p-4 rounded-xl mb-3';
                div.innerHTML = `
        <div class="flex items-center space-x-4">
            <div class="w-12 h-12 ${trans.tipo === 'expense' ? 'bg-red-100' : 'bg-green-100'} rounded-full flex items-center justify-center text-2xl">
                ${trans.tipo === 'expense' ? 'üõí' : 'üí∞'}
            </div>
            <div>
                <p class="font-semibold text-navy">${trans.descricao}</p>
                <p class="text-sm text-gray-500">
                    ${new Date(trans.data).toLocaleDateString('pt-PT')} ‚Ä¢ ${accountName} 
                    ${catName ? `<span class="bg-white px-2 py-0.5 rounded ml-2 text-xs border">${catName}</span>` : ''}
                </p>
            </div>
        </div>
        <div class="text-right">
            <p class="text-xl font-bold ${trans.tipo === 'expense' ? 'text-red-600' : 'text-green-600'}">
                ${trans.tipo === 'expense' ? '-' : '+'} ‚Ç¨${parseFloat(trans.valor).toFixed(2)}
            </p>
            <button onclick="deleteTransaction('${trans.id}')"
                class="text-sm text-red-600 underline hover:text-red-800 mt-2 block ml-auto">Excluir</button>
        </div>
        `;
                container.appendChild(div);
            });
        }

        // Criar Transa√ß√£o (POST)
        document.getElementById('transactionForm').addEventListener('submit', async e => {
            e.preventDefault();

            const desc = document.getElementById('transactionDescription').value;
            const accId = document.getElementById('transactionAccount').value;
            const amount = parseFloat(document.getElementById('transactionAmount').value);
            const type = document.getElementById('transactionType').value;
            const date = document.getElementById('transactionDate').value;

            // Pega o ID da categoria selecionada (pode ser vazio)
            const catInput = document.getElementById('transactionCategory');
            const categoryId = catInput && catInput.value ? catInput.value : null;

            try {
                const res = await fetch('/api/transactions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        description: desc,
                        amount: amount,
                        date: date,
                        type: type,
                        account_id: accId,
                        category_id: categoryId // Envia o ID para o backend
                    })
                });

                if (res.ok) {
                    await fetchAllData(); // Recarrega para atualizar saldos e listas
                    closeModal('transactionModal');
                    document.getElementById('transactionForm').reset();
                } else {
                    const err = await res.json();
                    showError(err.error || 'Erro ao criar transa√ß√£o');
                }
            } catch (e) { showError(e.message); }
        });

        // Apagar Transa√ß√£o
        window.deleteTransaction = async function (id) {
            if (!confirm('Apagar transa√ß√£o? O saldo da conta ser√° revertido.')) return;
            try {
                const res = await fetch(`/api/transactions/${id}`, { method: 'DELETE' });
                if (res.ok) fetchAllData();
            } catch (e) { console.error(e); }
        };

        document.getElementById('openTransactionModal').addEventListener('click', () => {
            loadAccountOptions(); // Carrega contas

            // Carrega categorias baseado no tipo atual (default: expense)
            const currentType = document.getElementById('transactionType').value || 'expense';
            loadCategoryOptions(currentType);

            document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
            openModal('transactionModal');
        });


        // --- GEST√ÉO DE OR√áAMENTOS (BUDGETS) ---

        function renderBudgets(calculatedBudgets) {
            const list = document.getElementById('limitsList');
            list.innerHTML = '';

            if (!calculatedBudgets || calculatedBudgets.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-500 py-8">Nenhum limite mensal definido.</p>';
                return;
            }

            calculatedBudgets.forEach(b => {
                const spent = b.current || 0;
                const limit = b.limite || 0;
                const percentage = limit > 0 ? (spent / limit) * 100 : 0;
                const isOver = spent > limit;
                const barColor = isOver ? 'bg-red-600' : (percentage >= 90 ? 'bg-yellow-500' : 'bg-green-500');

                // Tenta pegar o nome da categoria da lista de categorias global ou do objeto budget
                let catName = 'Or√ßamento';
                if (b.category_id) {
                    const cat = categories.find(c => c.id === b.category_id);
                    catName = cat ? cat.nome : (b.categories?.nome || 'Desconhecida');
                } else {
                    catName = b.name || 'Geral'; // Fallback para nome manual se existir
                }

                const div = document.createElement('div');
                div.className = `bg-light-gray/20 p-6 rounded-2xl shadow-md border-l-8 ${isOver ? 'border-red-600' : 'border-green-500'} mb-4`;
                div.innerHTML = `
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h3 class="text-xl font-bold text-navy">${catName}</h3>
                    <div class="mt-1">
                        <span class="text-lg font-bold text-navy">‚Ç¨${spent.toFixed(2)}</span>
                        <span class="text-sm text-gray-500"> de ‚Ç¨${limit.toFixed(2)}</span>
                    </div>
                </div>
                <div class="flex space-x-3">
                    <button onclick="deleteBudget('${b.id}')" class="text-red-600 hover:text-red-800 text-xl" title="Excluir">üóëÔ∏è</button>
                </div>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                <div class="${barColor} h-full transition-all duration-500" style="width: ${Math.min(percentage, 100)}%"></div>
            </div>
            ${isOver ? '<p class="text-red-600 text-xs font-bold mt-2">‚ö†Ô∏è Limite excedido!</p>' : ''}
        `;
                list.appendChild(div);
            });
        }

        // Calcular progresso
        function calculateBudgetsProgress() {
            // 1. Filtra or√ßamentos do m√™s atual (formato YYYY-MM)
            const monthStr = `${currentLimitsYear}-${String(currentLimitsMonth).padStart(2, '0')}`;

            const activeBudgets = budgets.filter(b => b.mes_ano === monthStr);

            // 2. Calcula gastos cruzando transactions.category_id com budgets.category_id
            activeBudgets.forEach(b => {
                b.current = 0;

                transactions.forEach(t => {
                    // Verifica se a transa√ß√£o √© 'expense' (despesa)
                    if (t.tipo === 'expense') {
                        // Verifica a data
                        const tDate = t.data.substring(0, 7); // YYYY-MM

                        // L√≥gica de correspond√™ncia:
                        // Se o budget tem category_id, soma apenas transa√ß√µes dessa categoria
                        if (b.category_id && t.category_id === b.category_id && tDate === monthStr) {
                            b.current += parseFloat(t.valor);
                        }
                        // Se o budget n√£o tem category_id (Gen√©rico/Manual), l√≥gica antiga ou ignorar
                        else if (!b.category_id && tDate === monthStr) {
                            // Opcional: L√≥gica para or√ßamentos "Gerais"
                        }
                    }
                });
            });

            renderBudgets(activeBudgets);
        }

        // Criar Budget (POST)
        // Criar Budget (POST)
        document.getElementById('limitForm').addEventListener('submit', async e => {
            e.preventDefault();

            const catSelect = document.getElementById('limitCategory');
            const categoryId = catSelect.value;

            // Verifica se uma categoria v√°lida foi selecionada
            if (!categoryId) {
                alert("Por favor selecione uma categoria v√°lida.");
                return;
            }

            // Encontra o nome da categoria para enviar (fallback se o backend precisar do nome)
            const selectedCat = categories.find(c => c.id == categoryId);
            const name = selectedCat ? selectedCat.nome : 'Or√ßamento';

            const amount = parseFloat(document.getElementById('limitAmount').value);
            const m = document.getElementById('limitMonth').value.padStart(2, '0');
            const y = document.getElementById('limitYear').value;
            const period = `${y}-${m}`;

            try {
                const res = await fetch('/api/budgets', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        amount: amount,
                        period: period,
                        category_id: categoryId // Envia o ID da categoria
                    })
                });

                if (res.ok) {
                    currentLimitsMonth = parseInt(m);
                    currentLimitsYear = parseInt(y);
                    await fetchAllData();
                    closeModal('limitsModal');
                    document.getElementById('limitForm').reset();
                } else {
                    showError('Erro ao criar or√ßamento');
                }
            } catch (err) { showError(err.message); }
        });

        // Listener para abrir modal de limites e (opcional) carregar categorias l√° tamb√©m
        document.getElementById('openLimitsModal').addEventListener('click', () => {
            document.getElementById('limitModalTitle').textContent = 'Novo Or√ßamento';
            document.getElementById('limitForm').reset();

            const limitSelect = document.getElementById('limitCategory');
            limitSelect.innerHTML = ''; // Limpa op√ß√µes anteriores

            if (!categories || categories.length === 0) {
                // Caso N√ÉO existam categorias
                const opt = document.createElement('option');
                opt.value = "";
                opt.textContent = "N√£o tem categorias";
                opt.disabled = true;
                opt.selected = true;
                limitSelect.appendChild(opt);
            } else {
                // Caso existam categorias
                const defaultOpt = document.createElement('option');
                defaultOpt.value = "";
                defaultOpt.textContent = "Selecione uma categoria";
                defaultOpt.disabled = true;
                defaultOpt.selected = true;
                limitSelect.appendChild(defaultOpt);

                categories.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.textContent = c.nome;
                    limitSelect.appendChild(opt);
                });
            }

            // Define data padr√£o
            document.getElementById('limitMonth').value = new Date().getMonth() + 1;
            document.getElementById('limitYear').value = new Date().getFullYear();

            openModal('limitsModal');
        });

        window.deleteBudget = async function (id) {
            if (!confirm('Apagar este or√ßamento?')) return;
            try {
                const res = await fetch(`/api/budgets/${id}`, { method: 'DELETE' });
                if (res.ok) fetchAllData();
            } catch (e) { console.error(e); }
        };


        // --- GEST√ÉO DE METAS (GOALS) ---

        function renderGoals() {
            const list = document.getElementById('goalsList');
            list.innerHTML = '';

            if (!goals || goals.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-500 py-6">Nenhuma meta definida ainda.</p>';
                return;
            }

            goals.forEach(goal => {
                const current = parseFloat(goal.valor_atual) || 0;
                const target = parseFloat(goal.valor_alvo) || 1;
                const perc = Math.min((current / target) * 100, 100);
                const deadline = goal.data_alvo ? new Date(goal.data_alvo).toLocaleDateString('pt-PT') : 'Sem data';

                const div = document.createElement('div');
                div.className = 'bg-light-gray/20 p-6 rounded-2xl shadow-md border-l-8 border-gold mb-4';
                div.innerHTML = `
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h3 class="text-xl font-bold text-navy">${goal.nome}</h3>
                    <p class="text-sm text-gray-600 mt-1">Prazo: ${deadline}</p>
                    <div class="mt-2">
                        <span class="text-lg font-bold text-navy">‚Ç¨${current.toFixed(2)}</span>
                        <span class="text-sm text-gray-500"> de ‚Ç¨${target.toFixed(2)}</span>
                    </div>
                </div>
                <div class="flex space-x-3">
                    <button onclick="deleteGoal('${goal.id}')" class="text-red-600 hover:text-red-800 text-xl" title="Excluir">üóëÔ∏è</button>
                </div>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                <div class="bg-gold h-full transition-all duration-500" style="width: ${perc}%"></div>
            </div>
            <div class="flex justify-between mt-2 text-sm">
                <span>${perc.toFixed(0)}% conclu√≠do</span>
            </div>
        `;
                list.appendChild(div);
            });
        }

        // Criar Meta (POST)
        document.getElementById('goalForm').addEventListener('submit', async e => {
            e.preventDefault();

            const name = document.getElementById('goalName').value;
            const target = parseFloat(document.getElementById('goalTarget').value);
            const deadline = document.getElementById('goalDeadline').value;

            try {
                const res = await fetch('/api/goals', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        target_amount: target, // API espera 'target_amount'
                        deadline: deadline
                    })
                });

                if (res.ok) {
                    await fetchAllData();
                    closeModal('goalModal');
                    document.getElementById('goalForm').reset();
                } else {
                    showError('Erro ao criar meta');
                }
            } catch (e) { showError(e.message); }
        });

        window.deleteGoal = async function (id) {
            if (!confirm('Apagar meta?')) return;
            try {
                const res = await fetch(`/api/goals/${id}`, { method: 'DELETE' });
                if (res.ok) fetchAllData();
            } catch (e) { console.error(e); }
        };

        document.getElementById('openGoalModal').addEventListener('click', () => {
            document.getElementById('goalModalTitle').textContent = 'Nova Meta';
            document.getElementById('goalForm').reset();
            openModal('goalModal');
        });


        // --- INICIALIZA√á√ÉO ---

        document.addEventListener('DOMContentLoaded', () => {
            // 1. Carregar nome do utilizador
            fetch('/api/user')
                .then(r => r.ok ? r.json() : Promise.reject())
                .then(data => {
                    const name = data.name ? data.name.split(' ')[0] : "Utilizador";
                    const els = document.querySelectorAll('#userName, #headerName');
                    els.forEach(el => el.textContent = name);
                })
                .catch(() => { });

            // 2. Carregar dados financeiros
            fetchAllData();

            // 3. Bot√£o Logout
            document.getElementById('btn-logout')?.addEventListener('click', () => window.location.href = '/logout');
        });
    </script>
</body>

</html>